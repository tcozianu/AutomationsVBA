Private obj As New WebDriver


Sub suppressionGetter()
Dim rng2 As Range
Dim rng1 As Range
Dim rng3 As Range
Dim rng4 As Range
Dim FindBy As New Selenium.By
Dim Style As WebElement
Dim mp As Selenium.SelectElement
Const MAX_WAIT_SEC As Long = 5

Set ws = ThisWorkbook.Sheets("Input")
Set wso = ThisWorkbook.Sheets("temp")
Set wst = ThisWorkbook.Sheets("OutputT")

LR = Worksheets("Input").Cells(Rows.Count, 1).End(xlUp).Row

    If IsEmpty(Range("C" & LR)) = False Then
    answer = MsgBox("Macro was already used for this batch. Do you want to re-run for the same DEAL IDs?", vbQuestion + vbYesNo + vbDefaultButton2, "Oh ups")
        If answer = vbYes Then
            Columns(3).EntireColumn.ClearContents
            ws.Range("C1") = "warnings"
        Else
            Exit Sub
        End If
     End If
     
Application.DisplayAlerts = False
Application.ScreenUpdating = False
    obj.AddArgument ("start-maximized")
    obj.Start "chrome", ""
    obj.Get "https://dealsinternalwebsite-******.com/"
    
    Set bl = ThisWorkbook.Sheets("Input")
    BenchMark = Timer
    
    
    For i = 2 To LR
    
    
    
    While IsEmpty(ws.Cells(i, 3)) = False
        i = i + 1
    Wend
    
    While IsEmpty(ws.Cells(i, 1)) = True
        ws.Cells(i, 3) = "empty"
        i = i + 1
    Wend
    
    Do
        obj.Wait (100)
    Loop While obj.IsElementPresent(FindBy.XPath("//*[@id='searchDealsHTML']/form/table/tbody/tr[1]/td[2]/select")) = False
    
    
    k = bl.Range("B" & i)
    
    If IsEmpty(k) Then
    MsgBox ("Please insert MP on B2")
    Else
    If k = "3" Then
    mp2 = "UK"
    ElseIf k = "4" Then
    mp2 = "DE"
    ElseIf k = "5" Then
    mp2 = "FR"
    ElseIf k = "35691" Then
    mp2 = "IT"
    ElseIf k = "44551" Then
    mp2 = "ES"
    Else
    mp2 = ws.Cells(i, 2)
    End If
    End If
  
    Set mp = obj.FindElementByXPath("//*[@id='searchDealsHTML']/form/table/tbody/tr[1]/td[2]/select").AsSelect
    mp.SelectByText (mp2)
    
    obj.FindElementByXPath("//*[@id='dealID']").SendKeys (ws.Cells(i, 1))
    
    obj.FindElementByXPath("//*[@id='searchDealsHTML']/form/div/button").Click
    
    Do
    obj.Wait (500)
    Loop While obj.IsElementPresent(FindBy.XPath("//*[@id='itemState']")) = False
    
    obj.FindElementByXPath("//*[@id='itemState']").Click
    
    'ws.Cells(i, 5) = obj.FindElementByXPath("//div[contains(@Style,'left: 215px; display: none;')]").Attribute("style")
    
    Do
    obj.Wait 500
    Loop While obj.IsElementPresent(FindBy.XPath("//div[contains(@Style,'left: 215px; display: none;')]")) = False
    
   ' If obj.IsElementPresent(By.XPath("//div[@class,'deals404'][@style,'display: block;']")) Then
     If obj.IsElementPresent(FindBy.ID("tableitemState")) = False Then
        ws.Cells(i, 3) = "not found"
        
    
    Else
        dealType = obj.FindElementByXPath("//*[@id='dealHeaderHTML']/div/div[3]").Text
        mpDeal = obj.FindElementByCss("div[class='dealsContents'] a:nth-child(2)").Text

        dataFullstart = obj.FindElementById("startDate").Text
        dataFullend = obj.FindElementById("endDate").Text

        CreatedBy = obj.FindElementByCss("#owner").Text

        dDataStart = Mid(dataFullstart, 9, 2)
        mDataStart = Mid(dataFullstart, 5, 3)
        
        Select Case mDataStart
            Case "Jan"
                mDataStart = "01"
            Case "Feb"
                mDataStart = "02"
            Case "Mar"
                mDataStart = "03"
            Case "Apr"
                mDataStart = "04"
            Case "May"
                mDataStart = "05"
            Case "Jun"
                mDataStart = "06"
            Case "Jul"
                mDataStart = "07"
            Case "Aug"
                mDataStart = "08"
            Case "Sep"
                mDataStart = "09"
            Case "Oct"
                mDataStart = "10"
            Case "Nov"
                mDataStart = "11"
            Case "Dec"
                mDataStart = "12"
        End Select

        dDataEnd = Mid(dataFullend, 9, 2)
        mDataEnd = Mid(dataFullend, 5, 3)
        
        Select Case mDataEnd
            Case "Jan"
                mDataEnd = "01"
            Case "Feb"
                mDataEnd = "02"
            Case "Mar"
                mDataEnd = "03"
            Case "Apr"
                mDataEnd = "04"
            Case "May"
                mDataEnd = "05"
            Case "Jun"
                mDataEnd = "06"
            Case "Jul"
                mDataEnd = "07"
            Case "Aug"
                mDataEnd = "08"
            Case "Sep"
                mDataEnd = "09"
            Case "Oct"
                mDataEnd = "10"
            Case "Nov"
                mDataEnd = "11"
            Case "Dec"
                mDataEnd = "12"
        End Select

        yDataStart = Mid(dataFullstart, 12, 4)
        yDataEnd = Mid(dataFullend, 12, 4)

        dataStart = dDataStart & "/" & mDataStart & "/" & yDataStart
        dataEnd = dDataEnd & "/" & mDataEnd & "/" & yDataEnd

        Do
        obj.Wait (500)
        Loop While obj.IsElementPresent(FindBy.ID("tableitemState")) = False


        'getting table in a new sheet
        Set Table = obj.FindElementByXPath("//*[@id='viewDealsHTML']/table")
            ActiveWorkbook.Worksheets.Add
            ActiveSheet.Name = "Sheett" & i - 1   'not optimal, change it in future, target the workbook thorugh thisworkbook.
            Set wsExt = ThisWorkbook.Sheets("Sheett" & i - 1)
            Table.AsTable.ToExcel wsExt
                With Range("A:A")
                 If .Find("PAWS Link") Is Nothing Then
                    Else
                     Set a = .Find("PAWS Link")
                     c = a.Address
                     d = Range(c).Offset(0, 1)
                     paws = Left(d, 11)
                 End If
                 If .Find("Title") Is Nothing Then
                     Else
                        Set f = .Find("Title")
                        g = f.Address
                        h = Range(g).Offset(0, 1)
                        titlu = h
                End If
                End With


        'getting table in a new sheet
        Do
        obj.Wait (100)
        Loop While obj.IsElementPresent(FindBy.ID("auditTrail")) = False
        
        obj.FindElementById("auditTrail").Click
        
        t = Timer
        Do
            If Timer - t > MAX_WAIT_SEC Then
            obj.Get (obj.Url)
                Do
                obj.Wait (100)
                Loop While obj.IsElementPresent(FindBy.ID("auditTrail")) = False
                
                obj.FindElementById("auditTrail").Click
                
            Exit Do
            End If
        Loop While obj.IsElementPresent(FindBy.XPath("//*[@id='auditTrailHTML']/table")) = False
        
        
        Do
        obj.Wait (300)
        Loop While obj.IsElementPresent(FindBy.XPath("//*[@id='auditTrailHTML']/table")) = False

        Set TableAudit = obj.FindElementByXPath("//*[@id='auditTrailHTML']/table")
            ActiveWorkbook.Worksheets.Add
            ActiveSheet.Name = "SheetTableAudit" & i - 1
            Set wsTableAudit = ThisWorkbook.Sheets("SheetTableAudit" & i - 1)
            TableAudit.AsTable.ToExcel wsTableAudit
            With Range("C:C")
                 If .Find("Deal is created") Is Nothing Then
                    Else
                     Set a = .Find("Deal is created")
                     c = a.Address
                     dataCreateFull = Range(c).Offset(0, -1)
                 End If
                If Len(dataCreateFull) = 38 Then
                    dDataCreate = Mid(dataCreateFull, 9, 2)
                    Else
                    dDataCreate = Mid(dataCreateFull, 8, 2)
                End If
                
                
                    Select Case mDataCreate
                        Case "Jan"
                            mDataCreate = "01"
                        Case "Feb"
                            mDataCreate = "02"
                        Case "Mar"
                            mDataCreate = "03"
                        Case "Apr"
                            mDataCreate = "04"
                        Case "May"
                            mDataCreate = "05"
                        Case "Jun"
                            mDataCreate = "06"
                        Case "Jul"
                            mDataCreate = "07"
                        Case "Aug"
                            mDataCreate = "08"
                        Case "Sep"
                            mDataCreate = "09"
                        Case "Oct"
                            mDataCreate = "10"
                        Case "Nov"
                            mDataCreate = "11"
                        Case "Dec"
                            mDataCreate = "12"
                    End Select

        dataCreate = dDataCreate & "/" & mDataCreate & "/" & yDataCreate
            End With

        'getting table in a new sheet
        Do
        obj.Wait (100)
        Loop While obj.IsElementPresent(FindBy.ID("itemPricing")) = False
        
        obj.FindElementById("itemPricing").Click
        
        Do
        obj.Wait (100)
        Loop While obj.IsElementPresent(FindBy.XPath("//*[@id='tableitemPricing']")) = False
        
        Set Table2 = obj.FindElementById("tableitemPricing")
            ActiveWorkbook.Worksheets.Add
            ActiveSheet.Name = "SheetTable" & i - 1
            Set wsTable = ThisWorkbook.Sheets("SheetTable" & i - 1)
            Table2.AsTable.ToExcel wsTable

            lrPrice = wsTable.Cells(Rows.Count, 1).End(xlUp).Row
        
            If lrPrice = 2 Then
                Set rngPrice = wsTable.Range("C2")
            Else
                Set rngPrice = wsTable.Range("C2:C" & lrPrice)
            End If


        'getting table in a new sheet
        Do
        obj.Wait (100)
        Loop While obj.IsElementPresent(FindBy.ID("itemState")) = False
        
        obj.FindElementById("itemState").Click
        
        Do
        obj.Wait (100)
        Loop While obj.IsElementPresent(FindBy.XPath("//*[@id='tableitemState']")) = False
        
        Set Table = obj.FindElementById("tableitemState")
            ActiveWorkbook.Worksheets.Add
            ActiveSheet.Name = "Sheet" & i - 1
            Set ws2 = ThisWorkbook.Sheets("Sheet" & i - 1)
            Table.AsTable.ToExcel ws2
        
            'copy data to temp
            LR2 = ws2.Cells(Rows.Count, 1).End(xlUp).Row
        
        With Range("B:B")
        If .Find("SUPPRESSED") Is Nothing Then
            ws.Cells(i, 3) = "no suppressed asins"
            Range("A2").Select
            'sa verific cate linii are tabelul
            NrAsini = Worksheets("Sheet" & i - 1).Cells(Rows.Count, 1).End(xlUp).Row
            
            If NrAsini = 2 Then
                 Set rng1 = ws2.Range("A2:D2")
                 Lrtemp = Worksheets("temp").Cells(Rows.Count, 1).End(xlUp).Row
                 
                 If Lrtemp = 1 Then
                    Set rng2 = wso.Range("A2:D2")
                    Set rngOut = wso.Range("K2")
                    rng1.Copy rng2
                    rngPrice.Copy rngOut
                    wso.Cells(2, 4) = ws.Cells(i, 1)
                    wso.Cells(2, 5) = paws
                    wso.Cells(2, 6) = titlu
                    wso.Cells(2, 7) = dataStart
                    wso.Cells(2, 8) = dataEnd
                    wso.Cells(2, 9) = CreatedBy
                    wso.Cells(2, 10) = mpDeal
                    wso.Cells(2, 12) = dataCreate
                    wso.Cells(2, 13) = dealType

                    ws2.Select
                    ActiveWindow.SelectedSheets.Delete
                    wsExt.Select
                    ActiveWindow.SelectedSheets.Delete
                    wsTable.Select
                    ActiveWindow.SelectedSheets.Delete
                    wsTableAudit.Select
                    ActiveWindow.SelectedSheets.Delete
                 Else
                    Lrtemp = Worksheets("temp").Cells(Rows.Count, 1).End(xlUp).Row
                    a = Lrtemp + 1
                    Set rng2 = wso.Range("A" & a & ":D" & a)
                    Set rngOut = wso.Range("K" & a)
                    rng1.Copy rng2
                    rngPrice.Copy rngOut
                    wso.Cells(a, 4) = ws.Cells(i, 1)
                    wso.Cells(a, 5) = paws
                    wso.Cells(a, 6) = titlu
                    wso.Cells(a, 7) = dataStart
                    wso.Cells(a, 8) = dataEnd
                    wso.Cells(a, 9) = CreatedBy
                    wso.Cells(a, 10) = mpDeal
                    wso.Cells(a, 12) = dataCreate
                    wso.Cells(a, 13) = dealType

                    ws2.Select
                    ActiveWindow.SelectedSheets.Delete
                    wsExt.Select
                    ActiveWindow.SelectedSheets.Delete
                    wsTable.Select
                    ActiveWindow.SelectedSheets.Delete
                    wsTableAudit.Select
                    ActiveWindow.SelectedSheets.Delete
                End If
            
            Else
                LrSh = Worksheets("Sheet" & i - 1).Cells(Rows.Count, 1).End(xlUp).Row
                Set rng1 = ws2.Range("A2:D" & LrSh).SpecialCells(xlCellTypeVisible)
                
                Lrtemp = Worksheets("temp").Cells(Rows.Count, 1).End(xlUp).Row
                Set rng2 = wso.Range("A" & Lrtemp + 1)
                Set rngOut = wso.Range("K" & Lrtemp + 1)
                rng1.Copy rng2
                rngPrice.Copy rngOut
                '============================================================ sa nu uit sa le pun si la celelalte else uri
                lrtemp2 = Worksheets("temp").Cells(Rows.Count, 1).End(xlUp).Row
                
                wso.Cells(Lrtemp + 1, 6) = titlu
                wso.Cells(Lrtemp + 1, 5) = paws
                wso.Cells(Lrtemp + 1, 4) = ws.Cells(i, 1)
                wso.Cells(Lrtemp + 1, 7) = dataStart
                wso.Cells(Lrtemp + 1, 8) = dataEnd
                wso.Cells(Lrtemp + 1, 9) = CreatedBy
                wso.Cells(Lrtemp + 1, 10) = mpDeal
                wso.Cells(Lrtemp + 1, 12) = dataCreate
                wso.Cells(Lrtemp + 1, 13) = dealType

                Set fillRange = wso.Range("D" & Lrtemp + 1 & ":D" & lrtemp2)
                Set fillRange2 = wso.Range("E" & Lrtemp + 1 & ":E" & lrtemp2)
                Set fillRange3 = wso.Range("F" & Lrtemp + 1 & ":F" & lrtemp2)
                Set fillRange4 = wso.Range("G" & Lrtemp + 1 & ":G" & lrtemp2)
                Set fillRange5 = wso.Range("H" & Lrtemp + 1 & ":H" & lrtemp2)
                Set fillRange6 = wso.Range("I" & Lrtemp + 1 & ":I" & lrtemp2)
                Set fillRange7 = wso.Range("J" & Lrtemp + 1 & ":J" & lrtemp2)
                Set fillRange8 = wso.Range("L" & Lrtemp + 1 & ":L" & lrtemp2)
                Set fillRange9 = wso.Range("M" & Lrtemp + 1 & ":M" & lrtemp2)

                fillRange.FillDown
                fillRange2.FillDown
                fillRange3.FillDown
                fillRange4.FillDown
                fillRange5.FillDown
                fillRange6.FillDown
                fillRange7.FillDown
                fillRange8.FillDown
                fillRange9.FillDown

                ws2.Select
                ActiveWindow.SelectedSheets.Delete
                wsExt.Select
                ActiveWindow.SelectedSheets.Delete
                wsTable.Select
                ActiveWindow.SelectedSheets.Delete
                wsTableAudit.Select
                ActiveWindow.SelectedSheets.Delete
            End If
        Else
            ws.Cells(i, 3) = "suppressed"
            Range("A2").Select
            NrAsini = Worksheets("Sheet" & i - 1).Cells(Rows.Count, 1).End(xlUp).Row
            
            If NrAsini = 2 Then
                 Set rng1 = ws2.Range("A2:D2")
                 Lrtemp = Worksheets("temp").Cells(Rows.Count, 1).End(xlUp).Row
                 
                 If Lrtemp = 1 Then
                    Set rng2 = wso.Range("A2:D2")
                    Set rngOut = wso.Range("K2")
                    rng1.Copy rng2
                    rngPrice.Copy rngOut

                    wso.Cells(2, 4) = ws.Cells(i, 1)
                    wso.Cells(2, 5) = paws
                    wso.Cells(2, 6) = titlu
                    wso.Cells(2, 7) = dataStart
                    wso.Cells(2, 8) = dataEnd
                    wso.Cells(2, 9) = CreatedBy
                    wso.Cells(2, 10) = mpDeal
                    wso.Cells(2, 12) = dataCreate
                    wso.Cells(2, 13) = dealType

                    ws2.Select
                    ActiveWindow.SelectedSheets.Delete
                    wsExt.Select
                    ActiveWindow.SelectedSheets.Delete
                    wsTable.Select
                    ActiveWindow.SelectedSheets.Delete
                    wsTableAudit.Select
                    ActiveWindow.SelectedSheets.Delete
                 Else
                    Lrtemp = Worksheets("temp").Cells(Rows.Count, 1).End(xlUp).Row
                    a = Lrtemp + 1
                    Set rng2 = wso.Range("A" & a & ":D" & a)
                    Set rngOut = wso.Range("K" & a)
                    rng1.Copy rng2
                    rngPrice.Copy rngOut

                    wso.Cells(a, 4) = ws.Cells(i, 1)
                    wso.Cells(a, 5) = paws
                    wso.Cells(a, 6) = titlu
                    wso.Cells(a, 7) = dataStart
                    wso.Cells(a, 8) = dataEnd
                    wso.Cells(a, 9) = CreatedBy
                    wso.Cells(a, 10) = mpDeal
                    wso.Cells(a, 12) = dataCreate
                    wso.Cells(a, 13) = dealType

                    ws2.Select
                    ActiveWindow.SelectedSheets.Delete
                    wsExt.Select
                    ActiveWindow.SelectedSheets.Delete
                    wsTable.Select
                    ActiveWindow.SelectedSheets.Delete
                    wsTableAudit.Select
                    ActiveWindow.SelectedSheets.Delete
                End If
            
            Else
                LrSh = Worksheets("Sheet" & i - 1).Cells(Rows.Count, 1).End(xlUp).Row
                Set rng1 = ws2.Range("A2:D" & LrSh).SpecialCells(xlCellTypeVisible)
                
                Lrtemp = Worksheets("temp").Cells(Rows.Count, 1).End(xlUp).Row
                Set rng2 = wso.Range("A" & Lrtemp + 1)
                Set rngOut = wso.Range("K" & Lrtemp + 1)
                rng1.Copy rng2
                rngPrice.Copy rngOut
                
                lrtemp2 = Worksheets("temp").Cells(Rows.Count, 1).End(xlUp).Row

                wso.Cells(Lrtemp + 1, 4) = ws.Cells(i, 1)
                wso.Cells(Lrtemp + 1, 5) = paws
                wso.Cells(Lrtemp + 1, 6) = titlu
                wso.Cells(Lrtemp + 1, 7) = dataStart
                wso.Cells(Lrtemp + 1, 8) = dataEnd
                wso.Cells(Lrtemp + 1, 9) = CreatedBy
                wso.Cells(Lrtemp + 1, 10) = mpDeal
                wso.Cells(Lrtemp + 1, 12) = dataCreate
                wso.Cells(Lrtemp + 1, 13) = dealType

                Set fillRange = wso.Range("D" & Lrtemp + 1 & ":D" & lrtemp2)
                Set fillRange2 = wso.Range("E" & Lrtemp + 1 & ":E" & lrtemp2)
                Set fillRange3 = wso.Range("F" & Lrtemp + 1 & ":F" & lrtemp2)
                Set fillRange4 = wso.Range("G" & Lrtemp + 1 & ":G" & lrtemp2)
                Set fillRange5 = wso.Range("H" & Lrtemp + 1 & ":H" & lrtemp2)
                Set fillRange6 = wso.Range("I" & Lrtemp + 1 & ":I" & lrtemp2)
                Set fillRange7 = wso.Range("J" & Lrtemp + 1 & ":J" & lrtemp2)
                Set fillRange8 = wso.Range("L" & Lrtemp + 1 & ":L" & lrtemp2)
                Set fillRange9 = wso.Range("M" & Lrtemp + 1 & ":M" & lrtemp2)

                fillRange.FillDown
                fillRange2.FillDown
                fillRange3.FillDown
                fillRange4.FillDown
                fillRange5.FillDown
                fillRange6.FillDown
                fillRange7.FillDown
                fillRange8.FillDown
                fillRange9.FillDown

                ws2.Select
                ActiveWindow.SelectedSheets.Delete
                wsExt.Select
                ActiveWindow.SelectedSheets.Delete
                wsTable.Select
                ActiveWindow.SelectedSheets.Delete
                wsTableAudit.Select
                ActiveWindow.SelectedSheets.Delete
            End If
        End If
        End With
    End If
    
        
    obj.Get "https://dealsinternalwebsite-eu.amazon.com/"
    Next
    
    
    'adaugare in tabelul mare
    finalLr = Worksheets("temp").Cells(Rows.Count, 1).End(xlUp).Row
    wso.Select
    '==================================================asins
    Set rng1 = wso.Range("A2:A" & finalLr)
    Set rng2 = wst.Range("B2:B" & finalLr)
    rng1.Copy rng2
    '==================================================Deal ID
    Set rng1 = wso.Range("D2:D" & finalLr)
    Set rng2 = wst.Range("M2:M" & finalLr)
    rng1.Copy rng2
    '==================================================Item State
    Set rng1 = wso.Range("B2:B" & finalLr)
    Set rng2 = wst.Range("AA2:AA" & finalLr)
    rng1.Copy rng2
    '==================================================Suppressed reason
    Set rng1 = wso.Range("C2:C" & finalLr)
    Set rng2 = wst.Range("AB2:AB" & finalLr)
    rng1.Copy rng2
    '==================================================PAWS ID
    Set rng1 = wso.Range("E2:E" & finalLr)
    Set rng2 = wst.Range("A2:A" & finalLr)
    rng1.Copy rng2
    '==================================================Titlu
    Set rng1 = wso.Range("F2:F" & finalLr)
    Set rng2 = wst.Range("O2:O" & finalLr)
    rng1.Copy rng2
    '==================================================dataStart
    Set rng1 = wso.Range("G2:G" & finalLr)
    Set rng2 = wst.Range("V2:V" & finalLr)
    rng1.Copy rng2
    '==================================================dataEnd
    Set rng1 = wso.Range("H2:H" & finalLr)
    Set rng2 = wst.Range("W2:W" & finalLr)
    rng1.Copy rng2
    '==================================================CreatedBy
    Set rng1 = wso.Range("I2:I" & finalLr)
    Set rng2 = wst.Range("X2:X" & finalLr)
    rng1.Copy rng2
    '==================================================dealMp
    Set rng1 = wso.Range("J2:J" & finalLr)
    Set rng2 = wst.Range("R2:R" & finalLr)
    rng1.Copy rng2
    '==================================================price
    Set rng1 = wso.Range("K2:K" & finalLr)
    Set rng2 = wst.Range("Z2:Z" & finalLr)
    rng1.Copy rng2
    '==================================================dataCreate
    Set rng1 = wso.Range("L2:L" & finalLr)
    Set rng2 = wst.Range("Y2:Y" & finalLr)
    rng1.Copy rng2
    '==================================================dealType
    Set rng1 = wso.Range("M2:M" & finalLr)
    Set rng2 = wst.Range("N2:N" & finalLr)
    rng1.Copy rng2
    
    Set rngFinal = wso.Range("A2:M" & finalLr)
    rngFinal.ClearContents
    
    wst.Select
    
    Application.ScreenUpdating = True
    obj.quit
    MsgBox "Done! Process took " & Format((Timer - BenchMark) / 86400, "hh:mm:ss")
    
    Application.DisplayAlerts = True
End Sub

